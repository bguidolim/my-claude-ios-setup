name: Release

on:
  push:
    tags:
      - '[0-9]*.[0-9]*.[0-9]*'

permissions:
  contents: write

concurrency:
  group: release

jobs:
  verify-version:
    name: Verify Version
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6

      - name: Verify tag matches source version
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          SOURCE_VERSION=$(grep -m1 'static let current' Sources/mcs/CLI.swift | sed 's/.*"\(.*\)".*/\1/')
          if [ "$SOURCE_VERSION" != "$TAG_NAME" ]; then
            echo "::error::Version mismatch: tag is '${TAG_NAME}' but MCSVersion.current is '${SOURCE_VERSION}'. Update MCSVersion.current in Sources/mcs/CLI.swift before tagging."
            exit 1
          fi
          echo "Version check passed: ${TAG_NAME}"

  resolve:
    name: Resolve Dependencies
    needs: verify-version
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/cache@v4
        with:
          path: |
            .build/checkouts
            .build/repositories
            .build/workspace-state.json
          key: spm-${{ runner.os }}-${{ hashFiles('Package.swift') }}
          restore-keys: spm-${{ runner.os }}-

      - name: Resolve packages
        run: swift package resolve

  test:
    name: Test
    needs: resolve
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/cache/restore@v4
        with:
          path: |
            .build/checkouts
            .build/repositories
            .build/workspace-state.json
          key: spm-${{ runner.os }}-${{ hashFiles('Package.swift') }}
          restore-keys: spm-${{ runner.os }}-

      - name: Test
        run: swift test

  build-and-release:
    name: Build and Release
    needs: [test]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/cache/restore@v4
        with:
          path: |
            .build/checkouts
            .build/repositories
            .build/workspace-state.json
          key: spm-${{ runner.os }}-${{ hashFiles('Package.swift') }}
          restore-keys: spm-${{ runner.os }}-

      - name: Build universal binary
        run: |
          swift build -c release --arch arm64 --arch x86_64
          echo "BIN_DIR=$(swift build -c release --arch arm64 --arch x86_64 --show-bin-path)" >> "$GITHUB_ENV"

      - name: Verify binary
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          BUILT_VERSION=$("${BIN_DIR}/mcs" --version)
          if [ "$BUILT_VERSION" != "$TAG_NAME" ]; then
            echo "::error::Built binary reports version '${BUILT_VERSION}' but tag is '${TAG_NAME}'"
            exit 1
          fi
          echo "Binary verified: ${BUILT_VERSION}"

      - name: Prepare artifacts
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          TARBALL="mcs-${TAG_NAME}-macos-universal.tar.gz"
          tar -czf "${TARBALL}" -C "${BIN_DIR}" mcs
          shasum -a 256 "${TARBALL}" > SHA256SUMS
          echo "TARBALL=${TARBALL}" >> "$GITHUB_ENV"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
          TARBALL: ${{ env.TARBALL }}
        run: |
          gh release create "${TAG_NAME}" \
            --verify-tag \
            --generate-notes \
            "${TARBALL}" SHA256SUMS

      - name: Update Homebrew tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
          TARBALL: ${{ env.TARBALL }}
        if: env.HOMEBREW_TAP_TOKEN != ''
        run: |
          SHA=$(shasum -a 256 "${TARBALL}" | cut -d' ' -f1)

          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/bguidolim/homebrew-tap.git" tap
          cd tap
          cat > Formula/managed-claude-stack.rb << FORMULA
          class ManagedClaudeStack < Formula
            desc "Configure Claude Code with MCP servers, plugins, skills, and hooks"
            homepage "https://github.com/bguidolim/mcs"
            url "https://github.com/bguidolim/mcs/releases/download/${TAG_NAME}/mcs-${TAG_NAME}-macos-universal.tar.gz"
            sha256 "${SHA}"
            version "${TAG_NAME}"
            license "MIT"

            def install
              libexec.install "mcs"
              bin.install_symlink libexec/"mcs"
              bin.install_symlink libexec/"mcs" => "managed-claude-stack"
            end

            test do
              assert_match "Managed Claude Stack", shell_output("#{bin}/mcs --help")
            end
          end
          FORMULA

          git add Formula/managed-claude-stack.rb
          git commit -m "Update managed-claude-stack to ${TAG_NAME}"
          git push
